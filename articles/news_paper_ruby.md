---
title: "Newspaperã‚’èª­ã‚“ã§ã¿ãŸ"
emoji: "ğŸ«¡"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["Rails", "Ruby"]
published: true
---

## Newspaper Gemã¨ã¯
æ–°èã˜ã‚ƒãªã„ã§ã™ã€‚Gemã®è©±ã§ã™ã€‚ï¼ˆã”ã‚ã‚“ãªã•ã„ï¼‰
https://github.com/komagata/newspaper

READMEã«ã‚ˆã‚‹ã¨ã€

> Newspaper is a small library that provides a pub/sub mechanism for ruby.
Newspaperã¯rubyã®pub/subæ©Ÿæ§‹ã‚’æä¾›ã™ã‚‹å°ã•ãªãƒ©ã‚¤ãƒ–ãƒ©ãƒªã§ã‚ã‚‹ã€‚ï¼ˆè¨³ï¼‰

**pub/subã¨ã¯ï¼Ÿ**
ãƒ‘ãƒ–ãƒªãƒƒã‚·ãƒ¥/ã‚µãƒ–ã‚¹ã‚¯ãƒ©ã‚¤ãƒ– ã®ç•¥ã€‚
ãƒ‘ãƒ–ãƒªãƒƒã‚·ãƒ£ãƒ¼ã¨ã‚µãƒ–ã‚¹ã‚¯ãƒ©ã‚¤ãƒãƒ¼ã®å¯¾è©±ã¯ãƒ–ãƒ­ãƒ¼ã‚«ãƒ¼ã«ã‚ˆã£ã¦åˆ¶å¾¡ã•ã‚Œã‚‹ã‚¹ã‚¿ã‚¤ãƒ«ã®ã“ã¨ã€‚
ç°¡å˜ã«ã„ã†ã¨ã€ãƒ‘ãƒ–ãƒªãƒƒã‚·ãƒ£ãƒ¼ã¯é€ã‚‹ãƒ‡ãƒ¼ã‚¿ãŒä½•ï¼ˆé€ä¿¡å…ˆï¼‰ã«ä½¿ã‚ã‚Œã‚‹ã‹çŸ¥ã‚‰ãªãã¦ã‚ˆãã€ã‚µãƒ–ã‚¹ã‚¯ãƒ©ã‚¤ãƒãƒ¼ã¯ä½•ï¼ˆé€ä¿¡å…ƒï¼‰ã‹ã‚‰é€ã‚‰ã‚Œã¦ãã‚‹ã‹çŸ¥ã‚‹å¿…è¦ãŒãªã„ã€‚ãƒ–ãƒ­ãƒ¼ã‚«ãƒ¼ãŒã‚ˆã—ãªã«ã‚„ã£ã¦ãã‚Œã‚‹ã¨ã„ã†ä»•çµ„ã¿ã®ã“ã¨ã§ã™ã€‚ã“ã®ãƒ¢ãƒ‡ãƒ«ã®åˆ©ç‚¹ã¯ã€pub/subã®ãŠäº’ã„ãŒç‹¬ç«‹ã—ã¦ã‚‹ã“ã¨ã§ã€ã‚·ã‚¹ãƒ†ãƒ ã®æŸ”è»Ÿæ€§ã¨æ‹¡å¼µæ€§ãŒé«˜ã¾ã‚‹ã“ã¨ã§ã™ã€‚

ã“ã®Gemã‚’ä½¿ç”¨ã™ã‚‹ã“ã¨ã§ã€ãã®ãƒ¡ãƒªãƒƒãƒˆã‚’Rubyã§ç°¡å˜ã«äº«å—ã§ãã¾ã™ï¼
ä»–ã«ã‚‚pub/subæ©Ÿæ§‹ã‚’æä¾›ã—ã¦ã„ã‚‹ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã¯ã‚ã‚Šã¾ã™ãŒã€Newspaperã¯éå¸¸ã«ã‚·ãƒ³ãƒ—ãƒ«ã«ãªã£ã¦ã„ã¾ã™ã€‚
å®Ÿéš›ã«åƒ•ãŒé€šã£ã¦ã„ã‚‹[FBC](https://bootcamp.fjord.jp/)ã®ã‚¢ãƒ—ãƒªã¯Newspaperã‚’ä½¿ç”¨ã—ã¦ã„ã¾ã™ã€‚
https://github.com/fjordllc/bootcamp

## ä½•ãŒã§ãã‚‹ã®ã‹ï¼Ÿ
ã¾ãšRailsã®ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯ã®ä»•çµ„ã¿ã‚’èª¬æ˜ã—ã¾ã™ã€‚

> ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯ã¨ã¯ã€ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®ãƒ©ã‚¤ãƒ•ã‚µã‚¤ã‚¯ãƒ«æœŸé–“ã«ãŠã‘ã‚‹ç‰¹å®šã®ç¬é–“ã«å‘¼ã³å‡ºã•ã‚Œã‚‹ãƒ¡ã‚½ãƒƒãƒ‰ã®ã“ã¨ã§ã™ã€‚
ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯ã‚’åˆ©ç”¨ã™ã‚‹ã“ã¨ã§ã€Active Recordã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆãŒä½œæˆ/ä¿å­˜/æ›´æ–°/å‰Šé™¤/æ¤œè¨¼/ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‹ã‚‰ã®èª­ã¿è¾¼ã¿ã€ãªã©ã®ã‚¤ãƒ™ãƒ³ãƒˆç™ºç”Ÿæ™‚ã«å¸¸ã«å®Ÿè¡Œã•ã‚Œã‚‹ã‚³ãƒ¼ãƒ‰ã‚’æ›¸ãã“ã¨ãŒã§ãã¾ã™ã€‚
ï¼ˆRailsã‚¬ã‚¤ãƒ‰ã‚ˆã‚Šå¼•ç”¨ï¼‰

ä»»æ„ã®ã‚¿ã‚¤ãƒŸãƒ³ã‚°ã§ã‚¤ãƒ™ãƒ³ãƒˆã‚’è¨­å®šã—ã€å‡¦ç†ã‚’è¡Œãˆã‚‹ã¨ã„ã†ã“ã¨ã§ã™ã­ã€‚
åˆ©ç”¨å¯èƒ½ãªActive Recordã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯ã¯ `after_save`ã‚„`after_create`ãªã©ãŸãã•ã‚“ã‚ã‚Šã¾ã™ã€‚
https://railsguides.jp/active_record_callbacks.html#%E5%88%A9%E7%94%A8%E5%8F%AF%E8%83%BD%E3%81%AA%E3%82%B3%E3%83%BC%E3%83%AB%E3%83%90%E3%83%83%E3%82%AF

ãŸã ã“ã®ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯ã«ã¯å•é¡ŒãŒå¤šã„ã§ã™ã€‚
- fat modelã«ãªã‚Šã‚„ã™ã„ã€‚
- ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯ã®å®Ÿè¡Œé †åºã®ä»•æ§˜ãŒè¤‡é›‘ã€‚
- ä¾å­˜é–¢ä¿‚ãŒè¦‹ãˆã«ãã„ã€‚
- ç‰¹å®šã®ã‚¿ã‚¤ãƒŸãƒ³ã‚°ã‚’è¨­å®šã—ã«ãã„ï¼ˆã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯ã«æ¡ä»¶åˆ†å²ã‚’å…¥ã‚Œã‚‹ã“ã¨ã‚‚ã§ãã‚‹ãŒã€ã‚¢ãƒ³ãƒãƒ‘ã‚¿ãƒ¼ãƒ³ï¼‰ã€‚
- å¯èª­æ€§ãŒè½ã¡ã‚‹ã€‚ï¼ˆã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯å‡¦ç†ãŒãªã„ã‹ï¼Ÿã¨å¸¸ã«æ°—ã«ã—ãªã„ã¨ã„ã‘ãªã„ã€‚å€‹äººçš„ã«ã¯ã“ã‚ŒãŒä¸€ç•ªã§ã‹ã„ã‹ã‚‚ï¼‰

ãªã©ãªã©ã€‚è¦ã¯ãƒ“ã‚¸ãƒã‚¹ãƒ­ã‚¸ãƒƒã‚¯ãŒè¤‡é›‘ã«ãªã‚‹ã¨ã„ã†å•é¡Œã«é›†ç´„ã•ã‚Œã¾ã™ã€‚
ã“ã‚Œã‚’è§£æ±ºã—ã¦ãã‚Œã‚‹ã®ãŒã€Newspaperã§ã™ã€‚

## ã©ã†ä½¿ã†ã®ï¼Ÿ
### README(usage)å¼•ç”¨

---
> Using ActiveRecord callbacks.
```ruby
class User
  after_create UserCallbacks.new
end

class UserCallbacks
  def after_save(user)
    # do something
  end
end

@user.save
```
If Newspaper is used, it can be written as follows.
```ruby
# app/models/sign_up_notifier.rb
class SignUpNotifier
  def call(payload)
    # do something
  end
end

# config/initializers/newspaper.rb
Rails.configuration.after_initialize do
  Newspaper.subscribe(:user_create, SignUpNotifier.new)
end

# app/controllers/users_controller.rb
Newspaper.publish(:user_create, payload)
```
---
ã¤ã¾ã‚Šã€

1. æœ€åˆã«ã‚¤ãƒ™ãƒ³ãƒˆã”ã¨ã«ã‚µãƒ–ã‚¹ã‚¯ãƒ©ã‚¤ãƒãƒ¼ã‚’è¨­å®šã™ã‚‹ã€‚
`Newspaper.subscribe(ã‚¤ãƒ™ãƒ³ãƒˆç¨®é¡ã®ã‚·ãƒ³ãƒœãƒ«, ãƒ‡ãƒ¼ã‚¿)`

2. ãƒ‘ãƒ–ãƒªãƒƒã‚·ãƒ£ãƒ¼ãŒç‰¹å®šã®ã‚¿ã‚¤ãƒŸãƒ³ã‚°ã§ã‚¤ãƒ™ãƒ³ãƒˆã‚’ç™ºè¡Œã™ã‚‹ã€‚
`Newspaper.publish(ã‚¤ãƒ™ãƒ³ãƒˆç¨®é¡ã®ã‚·ãƒ³ãƒœãƒ«, ãƒ‡ãƒ¼ã‚¿)`

3. ã‚µãƒ–ã‚¹ã‚¯ãƒ©ã‚¤ãƒãƒ¼ãŒé€šçŸ¥ã‚’å—ã‘å–ã‚Šã€ãƒ‡ãƒ¼ã‚¿ã‚’å‡¦ç†ã™ã‚‹
ã‚µãƒ–ã‚¹ã‚¯ãƒ©ã‚¤ãƒ–ã—ã¦ã„ã‚‹ã‚¯ãƒ©ã‚¹ãŒãƒ‡ãƒ¼ã‚¿ã‚’å—ã‘å–ã‚Šã€`call`ãƒ¡ã‚½ãƒƒãƒ‰å†…ã§ç‰¹å®šã®å‡¦ç†ã‚’å®Ÿè¡Œã—ã¾ã™ã€‚

ã“ã‚Œã«ã‚ˆã‚Šã€ã‚¤ãƒ™ãƒ³ãƒˆé§†å‹•å‹ãƒ—ãƒ­ã‚°ãƒ©ãƒŸãƒ³ã‚°ãŒå®¹æ˜“ã«ãªã‚Šã€æ‹¡å¼µæ€§ã‚‚é«˜ã¾ã‚Šã¾ã™ï¼
ä¾‹ãˆã°`user.create`ã—ãŸå¾Œã®ã‚¤ãƒ™ãƒ³ãƒˆãŒä»¥ä¸‹ã ã£ãŸã¨ã—ã¾ã™ã€‚ï¼ˆæ¥µç«¯ã‹ã¤é©å½“ãªä¾‹ã§ã™ãŒã€‚ã€‚ï¼‰
```ruby
def after_create(user)
  userã«ãƒ¡ãƒ¼ãƒ«ã‚’é€ã‚‹å‡¦ç†
  adminã«ãƒ¡ãƒ¼ãƒ«ã‚’é€ã‚‹å‡¦ç†
  APIãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’é€ã‚‹å‡¦ç†
ã€€userã«1000ã‚®ãƒ•ãƒˆã‚’é€ã‚‹å‡¦ç†
end
```
å¾“æ¥ã®æ–¹æ³•ã ã¨ä¸€å¾‹ã§ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯ãŒç™ºç”Ÿã—ã¦ã—ã¾ã£ãŸã‚Šã€æ°—è»½ã«User.createã§ããªããªã£ãŸã‚Šå¤§å¤‰ã§ã™ã€‚
ã“ã‚ŒãŒNewspaperã‚’ä½¿ã†ã¨ã€
```ruby
# app/notifiers/user_mail_notifier.rb
class UserMailNotifier
  def call(user)
    # userã«ãƒ¡ãƒ¼ãƒ«ã‚’é€ã‚‹å‡¦ç†
  end
end

# app/notifiers/admin_mail_notifier.rb
class AdminMailNotifier
  def call(user)
    # adminã«ãƒ¡ãƒ¼ãƒ«ã‚’é€ã‚‹å‡¦ç†
  end
end

# app/notifiers/api_request_notifier.rb
class ApiRequestNotifier
  def call(user)
    # APIãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’é€ã‚‹å‡¦ç†
  end
end

# app/notifiers/gift_sender.rb
class GiftSender
  def call(user)
    # userã«1000ã‚®ãƒ•ãƒˆã‚’é€ã‚‹å‡¦ç†
  end
end

# config/initializers/newspaper.rb
Rails.configuration.after_initialize do
  Newspaper.subscribe(:user_create, UserMailNotifier.new)
  Newspaper.subscribe(:user_create, AdminMailNotifier.new)
  Newspaper.subscribe(:user_create, ApiRequestNotifier.new)
  Newspaper.subscribe(:user_create, GiftSender.new)
end

# app/controllers/users_controller.rb
def create
  user = User.create(user_params)
  if user.persisted?
    Newspaper.publish(:user_create, user)
  end
end
```
ã®ã‚ˆã†ã«æŸ”è»Ÿã«ç®¡ç†ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚å„å‡¦ç†ã®ç‹¬ç«‹æ€§ã€ãã—ã¦ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®æ‹¡å¼µæ€§ã¨ä¿å®ˆæ€§ã‚’ä¿ã¤ã“ã¨ãŒã§ãã¾ã™ï¼ï¼

## ãŠã¾ã‘ï¼ˆã‚³ãƒ¼ãƒ‰ã‚’è¦—ã„ã¦ã¿ãŸï¼‰
ä¸­èº«ã¯ä»¥ä¸‹ã§ã™ã€‚
```ruby
# frozen_string_literal: true

require_relative "newspaper/version"

# namespace
module Newspaper
  class Error < StandardError; end

  @event_bus = {}

  class << self
    attr_reader :event_bus

    def subscribe(event, subscriber)
      @event_bus[event] ||= []
      @event_bus[event] << subscriber
    end

    def publish(event, payload)
      @event_bus[event] ||= []
      @event_bus[event].each do |subscriber|
        subscriber.call(payload)
      end
    end

    def clear(event)
      @event_bus.delete event
    end

    def clear_all
      @event_bus = {}
    end
  end
end
```
æµã‚Œã¨ã—ã¦ã¯ã€ã¨ã¦ã‚‚ã‚·ãƒ³ãƒ—ãƒ«ãªã‚‚ã®ã«ãªã£ã¦ã„ã¾ã™ã€‚
1. Railsã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®åˆæœŸåŒ–ãŒå®Œäº†ã—ãŸå¾Œã«ã€ã‚¤ãƒ™ãƒ³ãƒˆã®ã‚·ãƒ³ãƒœãƒ«é”ã‚’@event_busã«è©°ã‚è¾¼ã‚€ã€‚
2. publishãƒ¡ã‚½ãƒƒãƒ‰ãŒå®Ÿè¡Œã•ã‚Œã‚‹ã¨ã€@event_busã®ä¸­ã‹ã‚‰ã‚¤ãƒ™ãƒ³ãƒˆã‚’æ¤œç´¢ã—ã‚µãƒ–ã‚¹ã‚¯ãƒ©ã‚¤ãƒãƒ¼ãã‚Œãã‚Œã®callãƒ¡ã‚½ãƒƒãƒ‰ã‚’å®Ÿè¡Œã™ã‚‹ã€‚

`publish`ãƒ¡ã‚½ãƒƒãƒ‰ã®æœ€åˆã®è¡Œã¯ã€æŒ‡å®šã•ã‚ŒãŸã‚¤ãƒ™ãƒ³ãƒˆã«ã¾ã ã‚µãƒ–ã‚¹ã‚¯ãƒ©ã‚¤ãƒãƒ¼ãŒç™»éŒ²ã•ã‚Œã¦ã„ãªã„å ´åˆã«å‚™ãˆã€ã‚¨ãƒ©ãƒ¼ã‚’é˜²ããŸã‚ã«é…åˆ—ã‚’åˆæœŸåŒ–ã€ã§ã—ã‚‡ã†ã‹ã€‚

## çµ‚ã‚ã‚Šã«
æœ€è¿‘ã€ã‚³ãƒ¼ãƒ‰ãƒªãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã™ã‚‹ã®ãŒã¾ã™ã¾ã™æ¥½ã—ããªã£ã¦ãã¾ã—ãŸï¼
ç´°éƒ¨ã¾ã§ç†è§£ã—ã‚ˆã†ã¨ã—ã™ãã‚‹ç™–ã¯ã‚ã‚Šã¾ã™ãŒã€ã€ï¼ˆä»Šå›ã®ã‚ˆã†ã«ï¼‰
èª­ã‚“ã§ã„ãŸã ãã€ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã—ãŸã€œã€‚
